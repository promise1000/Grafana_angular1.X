{"version":3,"sources":["../src/legend.js"],"names":["angular","kbn","$","module","directive","popoverSrv","$timeout","link","scope","elem","$container","firstRender","ctrl","panel","data","seriesList","i","events","on","series","color","render","getSeriesIndexForElement","el","parents","toggleSeries","e","currentTarget","index","seriesInfo","scrollPosition","children","scrollTop","sortLegend","stat","legend","sort","sortDesc","getLegendHeaderHtml","statName","name","header","html","cssClass","getLegendPercentageHtml","openColorSelector","target","length","find","show","element","position","template","openOn","model","autoClose","toggleAxis","colorSelected","changeSeriesColor","legendType","empty","append","showValues","values","percentage","tableLayout","toggleClass","legendHeader","valueName","_","sortBy","stats","reverse","total","seriesShown","seriesElements","seriesData","labelName","hideEmpty","allIsNull","decimal","percentageDecimals","hiddenSeries","alias","enableCurrent","label","value","formatValue","pvalue","toFixed","push","maxHeight","height","topPadding","tbodyElem","css"],"mappings":"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","file":"legend.js","sourcesContent":["import angular from 'angular';\r\n// import _ from  'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport $ from 'jquery';\r\nimport 'jquery.flot';\r\nimport 'jquery.flot.time';\r\n\r\nangular.module('grafana.directives').directive('piechartLegend', function (popoverSrv, $timeout) {\r\n  return {\r\n    link: function (scope, elem) {\r\n      var $container = $('<section class=\"graph-legend\"></section>');\r\n      var firstRender = true;\r\n      var ctrl = scope.ctrl;\r\n      var panel = ctrl.panel;\r\n      var data;\r\n      var seriesList;\r\n      var i;\r\n\r\n      ctrl.events.on('render', function () {\r\n        data = ctrl.series;\r\n        if (data) {\r\n          for (var i in data) {\r\n            data[i].color = ctrl.data[i].color;\r\n          }\r\n          render();\r\n        }\r\n      });\r\n\r\n      function getSeriesIndexForElement (el) {\r\n        return el.parents('[data-series-index]').data('series-index');\r\n      }\r\n\r\n      function toggleSeries (e) {\r\n        var el = $(e.currentTarget);\r\n        var index = getSeriesIndexForElement(el);\r\n        var seriesInfo = seriesList[index];\r\n        var scrollPosition = $($container.children('tbody')).scrollTop();\r\n        ctrl.toggleSeries(seriesInfo);\r\n        $($container.children('tbody')).scrollTop(scrollPosition);\r\n      }\r\n\r\n      function sortLegend (e) {\r\n        var el = $(e.currentTarget);\r\n        var stat = el.data('stat');\r\n\r\n        if (stat !== panel.legend.sort) { panel.legend.sortDesc = null; }\r\n\r\n        // if already sort ascending, disable sorting\r\n        if (panel.legend.sortDesc === false) {\r\n          panel.legend.sort = null;\r\n          panel.legend.sortDesc = null;\r\n          ctrl.render();\r\n          return;\r\n        }\r\n\r\n        panel.legend.sortDesc = !panel.legend.sortDesc;\r\n        panel.legend.sort = stat;\r\n        ctrl.render();\r\n      }\r\n\r\n      function getLegendHeaderHtml (statName) {\r\n        var name = statName;\r\n\r\n        if (panel.legend.header) {\r\n          name = panel.legend.header;\r\n        }\r\n\r\n        var html = '<th class=\"pointer\" data-stat=\"' + statName + '\">' + name;\r\n\r\n        if (panel.legend.sort === statName) {\r\n          var cssClass = panel.legend.sortDesc ? 'fa fa-caret-down' : 'fa fa-caret-up';\r\n          html += ' <span class=\"' + cssClass + '\"></span>';\r\n        }\r\n\r\n        return html + '</th>';\r\n      }\r\n\r\n      function getLegendPercentageHtml (statName) {\r\n        var name = 'percentage';\r\n        var html = '<th class=\"pointer\" data-stat=\"' + statName + '\">' + name;\r\n\r\n        if (panel.legend.sort === statName) {\r\n          var cssClass = panel.legend.sortDesc ? 'fa fa-caret-down' : 'fa fa-caret-up';\r\n          html += ' <span class=\"' + cssClass + '\"></span>';\r\n        }\r\n\r\n        return html + '</th>';\r\n      }\r\n\r\n      function openColorSelector (e) {\r\n        // if we clicked inside poup container ignore click\r\n        if ($(e.target).parents('.popover').length) {\r\n          return;\r\n        }\r\n\r\n        var el = $(e.currentTarget).find('.fa-minus');\r\n        var index = getSeriesIndexForElement(el);\r\n        var series = seriesList[index];\r\n\r\n        $timeout(function () {\r\n          popoverSrv.show({\r\n            element: el[0],\r\n            position: 'bottom center',\r\n            template: '<series-color-picker series=\"series\" onToggleAxis=\"toggleAxis\" onColorChange=\"colorSelected\">' +\r\n            '</series-color-picker>',\r\n            openOn: 'hover',\r\n            model: {\r\n              autoClose: true,\r\n              series: series,\r\n              toggleAxis: function () {},\r\n              colorSelected: function (color) {\r\n                ctrl.changeSeriesColor(series, color);\r\n              }\r\n            }\r\n          });\r\n        });\r\n      }\r\n\r\n      function render () {\r\n        if (panel.legendType === 'On graph') {\r\n          $container.empty();\r\n          return;\r\n        }\r\n\r\n        if (firstRender) {\r\n          elem.append($container);\r\n          $container.on('click', '.graph-legend-icon', openColorSelector);\r\n          $container.on('click', '.graph-legend-alias', toggleSeries);\r\n          $container.on('click', 'th', sortLegend);\r\n          firstRender = false;\r\n        }\r\n\r\n        seriesList = data;\r\n\r\n        $container.empty();\r\n\r\n        var showValues = panel.legend.values || panel.legend.percentage;\r\n        var tableLayout = (\r\n            panel.legendType === 'Under graph' ||\r\n            panel.legendType === 'Right side'\r\n            ) && showValues;\r\n\r\n        $container.toggleClass('graph-legend-table', tableLayout);\r\n\r\n        var legendHeader;\r\n        if (tableLayout) {\r\n          var header = '<tr><th colspan=\"2\" style=\"text-align:left\"></th>';\r\n          if (panel.legend.values) {\r\n            header += getLegendHeaderHtml(ctrl.panel.valueName);\r\n          }\r\n          if (panel.legend.percentage) {\r\n            header += getLegendPercentageHtml(ctrl.panel.valueName);\r\n          }\r\n          header += '</tr>';\r\n          legendHeader = $(header);\r\n        }\r\n\r\n        if (panel.legend.sort) {\r\n          seriesList = _.sortBy(seriesList, function (series) {\r\n            return series.stats[panel.legend.sort];\r\n          });\r\n          if (panel.legend.sortDesc) {\r\n            seriesList = seriesList.reverse();\r\n          }\r\n        }\r\n\r\n        if (panel.legend.percentage) {\r\n          var total = 0;\r\n          for (i = 0; i < seriesList.length; i++) {\r\n            total += seriesList[i].stats[ctrl.panel.valueName];\r\n          }\r\n        }\r\n\r\n        var seriesShown = 0;\r\n        var seriesElements = [];\r\n\r\n        for (i = 0; i < seriesList.length; i++) {\r\n          var series = seriesList[i];\r\n          var seriesData = ctrl.data[i];\r\n          var labelName = 'Current Value';\r\n\r\n          // ignore empty series\r\n          if (panel.legend.hideEmpty && series.allIsNull) {\r\n            continue;\r\n          }\r\n          // ignore series excluded via override\r\n          if (!series.legend) {\r\n            continue;\r\n          }\r\n\r\n          var decimal = 2;\r\n          if (ctrl.panel.legend.percentageDecimals) {\r\n            decimal = ctrl.panel.legend.percentageDecimals;\r\n          }\r\n\r\n          var html = '<div class=\"graph-legend-series';\r\n          if (ctrl.hiddenSeries[series.alias]) { html += ' graph-legend-series-hidden'; }\r\n          html += '\" data-series-index=\"' + i + '\">';\r\n          html += '<span class=\"graph-legend-icon\" style=\"float:none;\">';\r\n          html += '<i class=\"fa fa-minus pointer\" style=\"color:' + seriesData.color + '\"></i>';\r\n          html += '</span>';\r\n\r\n          if (i === 0 && ctrl.panel.legend.enableCurrent == true) {\r\n            labelName = 'Current Value';\r\n          } else {\r\n            labelName = seriesData.label;\r\n          }\r\n          html += '<a class=\"graph-legend-alias\" style=\"float:none;\">' + labelName + '</a>';\r\n          \r\n          if (showValues && tableLayout) {\r\n            var value = series.stats[ctrl.panel.valueName];\r\n            if (panel.legend.values) {\r\n              html += '<div class=\"graph-legend-value\">' + ctrl.formatValue(value) + '</div>';\r\n            }\r\n            if (total) {\r\n              var pvalue = ((value / total) * 100).toFixed(decimal) + '%';\r\n              html += '<div class=\"graph-legend-value\">' + pvalue + '</div>';\r\n            }\r\n          }\r\n\r\n          html += '</div>';\r\n\r\n          seriesElements.push($(html));\r\n          seriesShown++;\r\n        }\r\n\r\n        if (tableLayout) {\r\n          var maxHeight = ctrl.height;\r\n\r\n          if (panel.legendType === 'Under graph') {\r\n            maxHeight = maxHeight / 2;\r\n          }\r\n\r\n          var topPadding = 6;\r\n          var tbodyElem = $('<tbody></tbody>');\r\n          tbodyElem.css('max-height', maxHeight - topPadding);\r\n          tbodyElem.append(legendHeader);\r\n          tbodyElem.append(seriesElements);\r\n          $container.append(tbodyElem);\r\n        } else {\r\n          $container.append(seriesElements);\r\n        }\r\n      }\r\n    }\r\n  };\r\n});\r\n"]}